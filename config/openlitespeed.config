# OpenLiteSpeed Configuration for MariaIntelligence\n# Load Balancing and Performance Optimization\n\n# Virtual Host Configuration\nvirtualhost mariaintelligence {\n    vhRoot                  /var/www/mariaintelligence\n    configFile              conf/vhosts/mariaintelligence/vhconf.conf\n    allowSymbolLink         1\n    enableScript            1\n    restrained              0\n    setUIDMode              0\n}\n\n# Script Handler for Node.js\nscriptHandler {\n    add                     lsnode:lsphp81 js\n    add                     lsnode:lsphp81 mjs\n}\n\n# External Applications - Node.js Backend\nextprocessor nodejs {\n    type                    nodejs\n    address                 127.0.0.1:3001\n    maxConns                100\n    env                     NODE_ENV=production\n    initTimeout             60\n    retryTimeout            0\n    respBuffer              0\n    backlog                 100\n    runOnStartUp            1\n    extMaxIdleTime          300\n    priority                0\n    memSoftLimit            500M\n    memHardLimit            600M\n    procSoftLimit           500\n    procHardLimit           600\n}\n\n# Load Balancer Configuration\nloadBalancer mariaintelligence-cluster {\n    type                    leastconn\n    healthCheck             1\n    healthCheckUri          /api/health\n    healthCheckInterval     30\n    healthCheckTimeout      5\n    healthCheckUnhealthyThreshold   3\n    healthCheckHealthyThreshold     2\n    \n    # Backend servers\n    workers {\n        server1 {\n            address         127.0.0.1:3001\n            weight          1\n        }\n        server2 {\n            address         127.0.0.1:3002\n            weight          1\n        }\n        server3 {\n            address         127.0.0.1:3003\n            weight          1\n        }\n    }\n}\n\n# HTTP/2 Configuration\nhttp2 {\n    enable                  1\n    streamTimeout           300\n    maxConcurrentStreams    100\n    initialWindowSize       65536\n    maxFrameSize            16384\n    maxHeaderListSize       8192\n    \n    # HTTP/2 Push\n    push {\n        pushPolicy          1\n        smartPush           1\n        pushQuota           20\n    }\n}\n\n# Compression Configuration\ncompression {\n    enable                  1\n    enableDynGzipCompress   1\n    gzipCompressLevel       6\n    compressibleTypes       text/*, application/x-javascript, application/javascript, application/json, image/svg+xml\n    gzipAutoUpdateStatic    1\n    gzipStaticCompressLevel 6\n    gzipMaxFileSize         10M\n    gzipMinFileSize         300\n}\n\n# Cache Configuration\ncache {\n    enable                  1\n    cacheStoreDir           /tmp/lshttpd/cache\n    totalCacheSize          100M\n    maxCachedFileSize       10M\n    checkPrivateCache       1\n    checkPublicCache        1\n    maxCachedSmallFileSize  4096\n    smallFileThreshold      4096\n    \n    # Cache policies\n    cachePolicy static {\n        enable              1\n        expireInSeconds     86400\n        cacheStale          1\n        cacheStaticFile     1\n    }\n    \n    cachePolicy dynamic {\n        enable              1\n        expireInSeconds     300\n        respHeaders         content-type, content-encoding, cache-control, expires\n    }\n}\n\n# Security Configuration\nsecurity {\n    # Rate limiting\n    perClientConnLimit      50\n    perClientReqLimit       100\n    staticReqPerSec         50\n    dynReqPerSec            20\n    outBandwidth            0\n    inBandwidth             0\n    \n    # Request filtering\n    reqHeaderFilterRule {\n        enable              1\n        logLevel            4\n        defaultAction       deny,status:403\n    }\n    \n    # Access control\n    accessDenyDir {\n        *$\n        /.\n        *.conf\n        *.log\n    }\n    \n    # Security headers\n    extraHeaders {\n        X-Frame-Options             DENY\n        X-Content-Type-Options      nosniff\n        X-XSS-Protection           \"1; mode=block\"\n        Referrer-Policy            origin-when-cross-origin\n        Permissions-Policy         \"camera=(), microphone=(), geolocation=()\"\n        Content-Security-Policy    \"default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'\"\n    }\n}\n\n# Tuning Parameters\ntuning {\n    maxConnections          2000\n    maxSSLConnections       1000\n    connTimeout             300\n    maxKeepAliveReq         1000\n    keepAliveTimeout        5\n    sndBufSize              0\n    rcvBufSize              0\n    maxReqURLLen            32768\n    maxReqHeaderSize        65536\n    maxReqBodySize          2047M\n    maxDynRespHeaderSize    32768\n    maxDynRespSize          2047M\n    enableH2C               1\n    \n    # Worker processes\n    children                1\n    childrenMaxIdleTime     300\n    inMemBufSize            60M\n    swappingDir             /tmp/lshttpd/swap\n    \n    # File handling\n    staticFileCacheSize     256K\n    dynFileCacheSize        20M\n    staticFileCachePurgeRate 0.2\n    dynFileCachePurgeRate   0.3\n}\n\n# Logging Configuration\nlogging {\n    log {\n        fileName            logs/error.log\n        logLevel            NOTICE\n        rollingSize         10M\n        keepDays           30\n        compressArchive    1\n    }\n    \n    accessLog {\n        fileName            logs/access.log\n        format              \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-agent}i\\\" %D\"\n        rollingSize         10M\n        keepDays           30\n        compressArchive    1\n        logHeaders         5\n    }\n}\n\n# Virtual Host Template\nvhTemplate mariaintelligence-template {\n    templateFile            conf/templates/mariaintelligence.conf\n    listeners               Default, SSL\n    \n    # Document root\n    member {\n        vhName              mariaintelligence\n        vhDomain            mariaintelligence.local\n        vhAliases           www.mariaintelligence.local\n        vhRoot              /var/www/mariaintelligence\n    }\n}\n\n# SSL Configuration\nssl {\n    keyFile                 /etc/ssl/private/mariaintelligence.key\n    certFile                /etc/ssl/certs/mariaintelligence.crt\n    certChain               1\n    ciphers                 EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH\n    enableECDHE             1\n    renegProtection         1\n    sslSessionCache         1\n    sslSessionTickets       1\n    enableSpdy              15\n    enableQuic              1\n    enableStapling          1\n    ocspRespMaxAge          86400\n}\n\n# Rewrite Rules for SPA\nrewrite {\n    enable                  1\n    autoLoadHtaccess        1\n    \n    # API routes\n    rules {\n        RewriteRule         ^/api/(.*)$ /api/$1 [QSA,L]\n        RewriteRule         ^/uploads/(.*)$ /uploads/$1 [QSA,L]\n    }\n    \n    # Frontend routes (SPA)\n    rules {\n        RewriteCond         %{REQUEST_FILENAME} !-f\n        RewriteCond         %{REQUEST_FILENAME} !-d\n        RewriteRule         ^(.*)$ /index.html [QSA,L]\n    }\n}\n\n# Module Configuration\nmodule cache {\n    ls_cache_enable         1\n    ls_cache_check_public   1\n    ls_cache_max_object_size 10485760\n    ls_cache_ignore_request_cache_control 1\n    ls_cache_ignore_response_cache_control 0\n}\n\n# Performance Monitoring\nmonitoring {\n    enable                  1\n    statsOutputDir          /tmp/lshttpd/stats\n    interval                60\n    \n    # Metrics to collect\n    metrics {\n        requests            1\n        bandwidth           1\n        connections         1\n        cache_hits          1\n        response_time       1\n    }\n}\n\n# Expires Headers for Static Assets\nexpires {\n    enableExpires           1\n    expiresByType {\n        image/*             \"access plus 1 month\"\n        text/css            \"access plus 1 week\"\n        application/javascript \"access plus 1 week\"\n        text/javascript     \"access plus 1 week\"\n        application/pdf     \"access plus 1 day\"\n    }\n}\n"