# ğŸÂ SPRINTÂ FINALÂ â€“Â â€œMariaFazÂ 100â€¯% Operacionalâ€

> **Objectivo:** depois destes passos o fluxo **PDFâ€¯â†’â€¯OCRâ€¯â†’â€¯ValidaÃ§Ã£oÂ â†’â€¯Reserva** funciona;
> dashboards mostram dados; orÃ§amentos respondem 200; e os testes ficam verdes.

---

## 0. PrÃ©â€‘condiÃ§Ãµes

* `.env` jÃ¡ contÃ©m

  ```
  PRIMARY_AI=openrouter
  OR_MODEL=mistral-ocr
  OPENROUTER_API_KEY=***
  HF_TOKEN=***
  ```
* Branch: **feat/finalize-ocr**

---

## 1. Rota Ãºnica de OCR

### 1.1 Backâ€‘end Â (`server/routes.ts`)

```ts
// ğŸ”„  substituir rota antiga
router.post("/api/ocr", upload.single("pdf"), ocrController.postOcr);
// remover/comentar qualquer rota /api/upload-pdf
```

### 1.2 Frontâ€‘end Â (`client/src/pages/pdf-upload/index.tsx`)

```tsx
// dentro do handleFileUpload
const form = new FormData();
files.forEach(f => form.append("pdf", f));
const res = await fetch("/api/ocr?provider=auto", { method:"POST", body:form });
const data = await res.json();  // {reservations, boxes, missing}
setOcrResult(data);
openDrawer();                   // abre o ValidationDrawer
```

---

## 2. Parser sem Gemini

`server/parsers/parseReservations.ts`

1. **Remover** ou comentar chamada `parseReservationDataWithGemini()`.
2. Fluxo desejado:

```ts
// 1) tentar extrair campos via regex
// 2) se faltar algo -> devolve missing[]
// 3) RolmOCR sÃ³ Ã© chamado quando handwritingScore > 0.4
```

---

## 3. Aliases para propriedades

### 3.1 Prisma schemaÂ (`prisma/schema.prisma`)

```prisma
model Property {
  id       Int      @id @default(autoincrement())
  name     String
  aliases  String[] @default([])
  // ...
}
```

```bash
npx prisma migrate dev -n add_aliases
```

### 3.2 ServiÃ§o de matching (`server/services/property.service.ts`)

```ts
import similarity from "string-similarity";

export async function matchByAlias(raw: string) {
  const props = await prisma.property.findMany();
  const names = props.flatMap(p => [p.name, ...p.aliases]);
  const { bestMatch } = similarity.findBestMatch(raw, names);
  if (bestMatch.rating < 0.6) return null;
  const prop = props.find(p => p.name === bestMatch.target || p.aliases.includes(bestMatch.target));
  return prop ? { id: prop.id, score: bestMatch.rating } : null;
}
```

---

## 4. UI de validaÃ§Ã£o

### 4.1 Componente DrawerÂ (`client/src/components/ValidationDrawer.tsx`)

```tsx
import { pdfjs, Document, Page } from "react-pdf";
pdfjs.GlobalWorkerOptions.workerSrc = `//cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjs.version}/pdf.worker.min.js`;

export default function ValidationDrawer({fileUrl, boxes, reservation, missing, onSave}) {
  // render PDF + rects + form dinÃ¢mico
}
```

### 4.2 IntegraÃ§Ã£o

* `UploadPDF.tsx` â†’ guarda `ocrResult` em estado e passa ao drawer.
* No `<form>` do drawer mostra `<Select>` de propriedades se `missing` inclui `"propertyId"`.

---

## 5. Endpoint de orÃ§amento

`server/controllers/budget.controller.ts`

```ts
export async function estimate(req, res) {
  const { nights, nightlyRate, feePct = 10 } = req.body;
  const total = nights * nightlyRate;
  const margin = total * (feePct / 100);
  res.json({ total, margin });
}
```

`server/routes.ts`

```ts
router.post("/api/budgets/estimate", budgetController.estimate);
```

---

## 6. Dashboard: correcÃ§Ã£o datas

`server/services/dashboard.service.ts`

```ts
const normalize = (d:string|Date) => new Date(d);
const stays = await prisma.reservation.findMany({
  where:{ checkInDate:{ gte: start, lt: end } }
});
const nights = stays.reduce((acc,s)=> acc + (normalize(s.checkOutDate)-normalize(s.checkInDate))/864e5,0);
```

---

## 7. Testes Jest

### 7.1 OCR routeÂ (`tests/ocr.spec.ts`)

```ts
it("processa PDF Sete Rios", async () => {
  const res = await request(app)
     .post("/api/ocr")
     .attach("pdf", "__tests__/data/Controlo_Sete Rios.pdf");
  expect(res.status).toBe(200);
  expect(res.body.reservations[0].guestName).toBeDefined();
});
```

### 7.2 OrÃ§amentoÂ (`tests/budget.spec.ts`)

```ts
it("faz orÃ§amento", async () => {
  const res = await request(app)
     .post("/api/budgets/estimate")
     .send({ nights: 5, nightlyRate: 100 });
  expect(res.body.total).toBe(500);
});
```

---

## 8. Scripts utilitÃ¡rios (opcional)

* `scripts/ocr-benchmark.ts` â€“ compara Mistral e Qwen em `tests/pdfs`
* `scripts/alias-generator.ts` â€“ gerar aliases a partir de nomes existentes

---

## 9. QA Manual (Checklist)

* [ ] **Upload** `Controlo_Sete Rios.pdf` â†’ drawer abre, campos autoâ€‘preenchidos.
* [ ] **Escolher propriedade** se nÃ£o detectada â†’ â€œGuardarâ€ e reserva surge no dashboard.
* [ ] **Imagem manuscrita** â†’ RolmOCR activa; campos extraÃ­dos.
* [ ] **OrÃ§amento** â†’ formulÃ¡rio devolve total.
* [ ] **Dashboard mensal** mostra nÃºmeros â‰  0.

---

## 10. Build & lint

```bash
pnpm dlx eslint . --fix
tsc --noEmit
pnpm test
```

**Tudo verde?**  âœ…Â GOÂ LIVE!
