;; PgBouncer Configuration for MariaIntelligence
;; Optimized for Hostinger VPS Production Environment
;; 
;; Author: Database-Agent
;; Version: 1.0.0
;; Date: 2025-08-27

[databases]
;; Database connections
mariaintelligence = host=localhost port=5432 dbname=mariaintelligence user=mariaintelligence_user password=
mariaintelligence_readonly = host=localhost port=5432 dbname=mariaintelligence user=mariaintelligence_readonly password=
mariaintelligence_analytics = host=localhost port=5432 dbname=mariaintelligence user=mariaintelligence_analytics password=

;; Test database for development
mariaintelligence_test = host=localhost port=5432 dbname=mariaintelligence_test user=mariaintelligence_test password=

[pgbouncer]
;; Administrative settings
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid
unix_socket_dir = /var/run/pgbouncer
unix_socket_mode = 0777
unix_socket_group = pgbouncer

;; Connection settings
listen_addr = 127.0.0.1
listen_port = 6432

;; Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
auth_hba_file = /etc/pgbouncer/pg_hba.conf

;; Pool settings optimized for MariaIntelligence workload
pool_mode = transaction
max_client_conn = 200
default_pool_size = 25
min_pool_size = 5
reserve_pool_size = 5
reserve_pool_timeout = 3

;; Connection limits per database
;; Main application pool
mariaintelligence_pool_size = 20
mariaintelligence_min_pool_size = 5
mariaintelligence_max_db_connections = 20

;; Read-only pool for queries
mariaintelligence_readonly_pool_size = 15
mariaintelligence_readonly_min_pool_size = 3
mariaintelligence_readonly_max_db_connections = 15

;; Analytics pool for heavy queries
mariaintelligence_analytics_pool_size = 8
mariaintelligence_analytics_min_pool_size = 2
mariaintelligence_analytics_max_db_connections = 8

;; Timeouts (in seconds)
server_connect_timeout = 15
server_login_retry = 1
query_timeout = 30
query_wait_timeout = 120
client_idle_timeout = 600
server_idle_timeout = 600
server_lifetime = 3600
server_reset_query = DISCARD ALL
server_reset_query_always = 0

;; Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
stats_period = 60

;; Performance tuning
application_name_add_host = 1
autodb_idle_timeout = 3600
client_login_timeout = 60
default_pool_size = 25
ignore_startup_parameters = extra_float_digits,search_path

;; Security settings
admin_users = mariaintelligence_admin
stats_users = mariaintelligence_admin, mariaintelligence_stats

;; SSL/TLS settings (enable in production)
;server_tls_sslmode = require
;server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
;server_tls_key_file = /etc/pgbouncer/server.key
;server_tls_cert_file = /etc/pgbouncer/server.crt
;server_tls_protocols = secure
;server_tls_ciphers = HIGH:!aNULL:!MD5

;client_tls_sslmode = require
;client_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
;client_tls_key_file = /etc/pgbouncer/client.key
;client_tls_cert_file = /etc/pgbouncer/client.crt
;client_tls_protocols = secure
;client_tls_ciphers = HIGH:!aNULL:!MD5

;; Memory usage
pkt_buf = 4096
listen_backlog = 128
sbuf_loopcnt = 5
suspend_timeout = 10
tcp_defer_accept = 0
tcp_keepalive = 1
tcp_keepcnt = 9
tcp_keepidle = 7200
tcp_keepintvl = 75
tcp_user_timeout = 0

;; Special pools for specific workloads
;; OCR processing pool
mariaintelligence_ocr = host=localhost port=5432 dbname=mariaintelligence user=mariaintelligence_ocr password= pool_size=10 max_db_connections=10

;; Cleaning teams pool
mariaintelligence_cleaning = host=localhost port=5432 dbname=mariaintelligence user=mariaintelligence_cleaning password= pool_size=8 max_db_connections=8

;; Financial operations pool
mariaintelligence_financial = host=localhost port=5432 dbname=mariaintelligence user=mariaintelligence_financial password= pool_size=5 max_db_connections=5